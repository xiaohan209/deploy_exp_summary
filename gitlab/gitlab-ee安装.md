# gitlab安装

## [配置条件及要求][https://docs.gitlab.com/ee/install/requirements.html]：

###### 系统：ubuntu-20.04 focal

###### Gitlab版本：gitlab-ee14.4.1

###### 安装类型：安装包Omnibus GitLab



## Omnibus Gitlab安装方法

> 安装包相关的[信息链接][https://docs.gitlab.com/omnibus/]

### 包类型说明

[`gitlab/gitlab-ee`](https://packages.gitlab.com/gitlab/gitlab-ee)：包含所有社区版功能和[企业版](https://about.gitlab.com/pricing/)功能的完整 GitLab 包 。

[`gitlab/gitlab-ce`](https://packages.gitlab.com/gitlab/gitlab-ce)：仅包含社区版功能的精简包。

[`gitlab/unstable`](https://packages.gitlab.com/gitlab/unstable)：发布候选版本和其他不稳定版本。

[`gitlab/nightly-builds`](https://packages.gitlab.com/gitlab/nightly-builds): 每晚构建。

[`gitlab/raspberry-pi2`](https://packages.gitlab.com/gitlab/raspberry-pi2)：为[Raspberry Pi](https://www.raspberrypi.org/)软件包构建的官方社区版版本。



### 具体安装步骤

1. 安装最基础的依赖：

   ```shell
   sudo apt-get update
   sudo apt-get install -y curl openssh-server ca-certificates tzdata perl gnupg
   ```

2. 添加远程仓库

   ```shell
   curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | sudo bash
   ```

   

3. 换源（如果有代理或者速度OK的话可以跳过

   ```shell
   sudo vim /etc/apt/sources.list.d/gitlab_gitlab-ee.list
   ```

   可以看到文件内容为：

   ```shell
   # this file was generated by packages.gitlab.com for
   # the repository at https://packages.gitlab.com/gitlab/gitlab-ee
   
   deb https://packages.gitlab.com/gitlab/gitlab-ee/ubuntu/ focal main
   deb-src https://packages.gitlab.com/gitlab/gitlab-ee/ubuntu/ focal main
   ```

   将源文件最后两行注释，并添加清华源，完成后文件如下：

   ```shell
   # this file was generated by packages.gitlab.com for
   # the repository at https://packages.gitlab.com/gitlab/gitlab-ee
   
   #deb https://packages.gitlab.com/gitlab/gitlab-ee/ubuntu/ focal main
   #deb-src https://packages.gitlab.com/gitlab/gitlab-ee/ubuntu/ focal main
   deb https://mirrors.tuna.tsinghua.edu.cn/gitlab-ee/ubuntu/ focal main
   deb-src https://mirrors.tuna.tsinghua.edu.cn/gitlab-ee/ubuntu/ focal main
   ```

4. 进行安装，安装前请先查看第七部说明：

   1. 最新版本

      ```shell
      sudo apt update && sudo apt install gitlab-ee
      ```

   2. 特定版本

      ```shell
      sudo apt-cache madison gitlab-ee
      sudo apt install gitlab-ee=<version>
      ```

5. 检查一下：

   1. 查看当前gitlab状态：

      ```shell
      sudo gitlab-ctl status
      sudo gitlab-rake gitlab:check SANITIZE=true
      ```

   2. 查看目前版本：

      ```shell
      # 查看目前gitlab版本
      cat /opt/gitlab/embedded/service/gitlab-rails/VERSION
      # 查看其他gitlab组件版本
      grep . /opt/gitlab/embedded/service/gitlab-rails/*VERSION 
      ```

6. 打开`/etc/gitlab/gitlab.rb`文件，找到下行，并修改自己的主机名:

   ```shell
   external_url 'http://gitlab.xxxxxx.xxx"
   ```

7. 在`/etc/gitlab/initial_root_password`有root用户的密码，使用密码登录root账号，并保存，默认情况下，在第一次`gitlab-ctl reconfigure`之后的24小时文件会被删掉（如果 GitLab 在安装期间无法检测到服务器的有效主机名，则不会运行重新配置）

   > 提供自定义初始root密码，需要在第一次重新配置之前，编辑`/etc/gitlab/gitlab.rb`并设置：
   >
   > ```ruby
   > gitlab_rails['initial_root_password'] = '<my_strong_password>'
   > ```
   >
   > 由于安装后可能自动执行`gitlab-ctl reconfigure`，因此也可以在安装的时候将`GITLAB_ROOT_PASSWORD`环境变量传递给`apt install`，并在`gitlab-ctl reconfigure`的时候也输入此变量，即：
   >
   > ```shell
   > sudo EXTERNAL_URL="https://gitlab.example.com" GITLAB_ROOT_PASSWORD="YourPassword" apt-get install gitlab-ee
   > ```
   
   可参见[重置 root 密码](https://docs.gitlab.com/ee/security/reset_user_password.html)
   













# gitlab其他组件安装部署

## 邮件服务器SMTP：

gitlab推荐使用postfix邮件服务器，直接安装：

```shell
sudo apt-get install -y postfix
```

安装时候需要选择选项`Internet Site`，输入希望设置的域名即可，如果需要其他SMTP服务可参考[外部SMTP服务器设置][https://docs.gitlab.com/omnibus/settings/smtp.html]





## LDAP绑定

对于Omnibus安装方式，直接在`/etc/gitlab/gitlab.rb`加入以下配置：

```ruby
gitlab_rails['ldap_enabled'] = true
gitlab_rails['prevent_ldap_sign_in'] = false
gitlab_rails['ldap_servers'] = {
'main' => {
  'label' => 'LDAP',
  'host' =>  'ldap.mydomain.com',
  'port' => 389,
  'uid' => 'sAMAccountName',
  'encryption' => 'simple_tls',
  'verify_certificates' => true,
  'bind_dn' => '_the_full_dn_of_the_user_you_will_bind_with',
  'password' => '_the_password_of_the_bind_user',
  'tls_options' => {
    'ca_file' => '',
    'ssl_version' => '',
    'ciphers' => '',
    'cert' => '',
    'key' => ''
  },
  'timeout' => 10,
  'active_directory' => true,
  'allow_username_or_email_login' => false,
  'block_auto_created_users' => false,
  'base' => 'dc=example,dc=com',
  'user_filter' => '',
  'attributes' => {
    'username' => ['uid', 'userid', 'sAMAccountName'],
    'email' => ['mail', 'email', 'userPrincipalName'],
    'name' => 'cn',
    'first_name' => 'givenName',
    'last_name' => 'sn'
  },
  'lowercase_usernames' => false,

  # EE Only
  'group_base' => '',
  'admin_group' => '',
  'external_groups' => [],
  'sync_ssh_keys' => false
  }
}
```

