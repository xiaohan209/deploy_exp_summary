# Gitlab-EE edition

## Gitlab 介紹

## Gitlab 安装

### [配置条件及要求](https://docs.gitlab.com/ee/install/requirements.html)：

###### 系统：ubuntu-20.04 focal

###### Gitlab版本：gitlab-ee14.4.1

###### 安装类型：安装包Omnibus GitLab

### Omnibus Gitlab安装方法

> 安装包相关的[信息链接](https://docs.gitlab.com/omnibus/)

#### 包类型说明

[`gitlab/gitlab-ee`](https://packages.gitlab.com/gitlab/gitlab-ee)：包含所有社区版功能和[企业版](https://about.gitlab.com/pricing/)功能的完整 GitLab 包 。

[`gitlab/gitlab-ce`](https://packages.gitlab.com/gitlab/gitlab-ce)：仅包含社区版功能的精简包。

[`gitlab/unstable`](https://packages.gitlab.com/gitlab/unstable)：发布候选版本和其他不稳定版本。

[`gitlab/nightly-builds`](https://packages.gitlab.com/gitlab/nightly-builds): 每晚构建。

[`gitlab/raspberry-pi2`](https://packages.gitlab.com/gitlab/raspberry-pi2)：为[Raspberry Pi](https://www.raspberrypi.org/)软件包构建的官方社区版版本。

#### 具体安装步骤

1. 安装最基础的依赖：

   ```shell
   sudo apt-get update
   sudo apt-get install -y curl openssh-server ca-certificates tzdata perl gnupg
   ```

2. 添加远程仓库

   ```shell
   curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.deb.sh | sudo bash
   ```

3. 换源（如果有代理或者速度OK的话可以跳过

   ```shell
   sudo vim /etc/apt/sources.list.d/gitlab_gitlab-ee.list
   ```

   可以看到文件内容为：

   ```shell
   # this file was generated by packages.gitlab.com for
   # the repository at https://packages.gitlab.com/gitlab/gitlab-ee
   
   deb https://packages.gitlab.com/gitlab/gitlab-ee/ubuntu/ focal main
   deb-src https://packages.gitlab.com/gitlab/gitlab-ee/ubuntu/ focal main
   ```

   将源文件最后两行注释，并添加清华源，完成后文件如下：

   ```shell
   # this file was generated by packages.gitlab.com for
   # the repository at https://packages.gitlab.com/gitlab/gitlab-ee
   
   #deb https://packages.gitlab.com/gitlab/gitlab-ee/ubuntu/ focal main
   #deb-src https://packages.gitlab.com/gitlab/gitlab-ee/ubuntu/ focal main
   deb https://mirrors.tuna.tsinghua.edu.cn/gitlab-ee/ubuntu/ focal main
   deb-src https://mirrors.tuna.tsinghua.edu.cn/gitlab-ee/ubuntu/ focal main
   ```

4. 进行安装，安装前请先查看第七部说明：

   1. 最新版本

      ```shell
      sudo apt update && sudo apt install gitlab-ee
      ```

   2. 特定版本

      ```shell
      sudo apt-cache madison gitlab-ee
      sudo apt install gitlab-ee=<version>
      ```

   3. 更新时如果出现错误，请看[更新相关内容](#更新相关)

5. 检查一下：

   1. 查看当前gitlab状态：

      ```shell
      sudo gitlab-ctl status
      sudo gitlab-rake gitlab:check SANITIZE=true
      ```

   2. 查看目前版本：

      ```shell
      # 查看目前gitlab版本
      cat /opt/gitlab/embedded/service/gitlab-rails/VERSION
      # 查看其他gitlab组件版本
      grep . /opt/gitlab/embedded/service/gitlab-rails/*VERSION 
      ```

6. 打开`/etc/gitlab/gitlab.rb`文件，找到下行，并修改自己的主机名:

   ```shell
   external_url 'http://gitlab.xxxxxx.xxx"
   ```

7. 在`/etc/gitlab/initial_root_password`有root用户的密码，使用密码登录root账号，并保存，默认情况下，在第一次`gitlab-ctl reconfigure`之后的24小时文件会被删掉（如果 GitLab 在安装期间无法检测到服务器的有效主机名，则不会运行重新配置）

   > 提供自定义初始root密码，需要在第一次重新配置之前，编辑`/etc/gitlab/gitlab.rb`并设置：
   >
   > ```ruby
   > gitlab_rails['initial_root_password'] = '<my_strong_password>'
   > ```
   >
   > 由于安装后可能自动执行`gitlab-ctl reconfigure`，因此也可以在安装的时候将`GITLAB_ROOT_PASSWORD`环境变量传递给`apt install`，并在`gitlab-ctl reconfigure`的时候也输入此变量，即：
   >
   > ```shell
   > sudo EXTERNAL_URL="https://gitlab.example.com" GITLAB_ROOT_PASSWORD="YourPassword" apt-get install gitlab-ee
   > ```

   可参见[重置 root 密码](https://docs.gitlab.com/ee/security/reset_user_password.html)

## gitlab其他组件安装部署

## 邮件服务器SMTP

gitlab推荐使用postfix邮件服务器，直接安装：

```shell
sudo apt-get install -y postfix
```

安装时候需要选择选项`Internet Site`，输入希望设置的域名即可，如果需要其他SMTP服务可参考[外部SMTP服务器设置](https://docs.gitlab.com/omnibus/settings/smtp.html)

## Gitlab使用

### [LDAP绑定](https://docs.gitlab.com/ee/administration/auth/ldap/index.html#ssl-configuration-settings)

#### Omnibus软件包配置

直接在`/etc/gitlab/gitlab.rb`加入以下配置：

```ruby
gitlab_rails['ldap_enabled'] = true
gitlab_rails['prevent_ldap_sign_in'] = false
gitlab_rails['ldap_servers'] = {
'main' => {
  'label' => 'LDAP',
  'host' =>  'ldap.mydomain.com',
  'port' => 389,
  'uid' => 'uid',
  'encryption' => 'simple_tls',
  'verify_certificates' => true,
  'bind_dn' => '_the_full_dn_of_the_user_you_will_bind_with',
  'password' => '_the_password_of_the_bind_user',
  'tls_options' => {
    'ca_file' => '',
    'ssl_version' => '',
    'ciphers' => '',
    'cert' => '',
    'key' => ''
  },
  'timeout' => 10,
  'active_directory' => true,
  'allow_username_or_email_login' => false,
  #设置禁止通过LDAP新注册用户
  'block_auto_created_users' => false,
  'base' => 'dc=example,dc=com',
  'user_filter' => '',
  'attributes' => {
    'username' => ['uid', 'userid', 'sAMAccountName'],
    'email' => ['mail', 'email', 'userPrincipalName'],
    'name' => 'cn',
    'first_name' => 'givenName',
    'last_name' => 'sn'
  },
  'lowercase_usernames' => false,

  # EE Only
  'group_base' => '',
  'admin_group' => '',
  'external_groups' => [],
  'sync_ssh_keys' => false
  }
}
```

#### 源代码安装配置

在`/home/git/gitlab/config/gitlab.yml`中添加：

```ruby
production:
  # snip...
  ldap:
    enabled: false
    prevent_ldap_sign_in: false
    servers:
      main:
        label: 'LDAP'
        ...
```

### 使用外部后端代理

> - [官方教程与说明](https://docs.gitlab.com/omnibus/settings/nginx.html)
> - [官方recipe](https://gitlab.com/gitlab-org/gitlab-recipes/-/tree/master/web-server)
> - 博客參考:
>   - <https://segmentfault.com/a/1190000020791442>
>   - <https://gist.github.com/atd-schubert/d30998e5d245e993c264>

使用外部Nginx操作步骤:

1. 编辑`/etc/gitlab/gitlab.rb`配置文件：

   ```ruby
   # 填入外部访问域名
   external_url 'http://git.example.com'
   # Disable the built-in nginx
   nginx['enable'] = false
   # Disable the built-in puma
   puma['enable'] = false
   # Set the internal API URL 填入域名
   gitlab_rails['internal_api_url'] = 'http://git.example.com'
   # Define the web server process user (ubuntu/nginx)
   web_server['external_users'] = ['www-data']
   ```

2. 添加gitlab相关配置文件到外部nginx配置中：

   ```nginx
   upstream gitlab-workhorse {
      server unix://var/opt/gitlab/gitlab-workhorse/sockets/socket fail_timeout=0;
   }

   server {
      listen *:80;
      # 填入自己的域名
      server_name git.example.com;
      server_tokens off;
      root /opt/gitlab/embedded/service/gitlab-rails/public;

      client_max_body_size 250m;

      access_log  /var/log/nginx/gitlab_access.log;
      error_log   /var/log/nginx/gitlab_error.log;

      # Ensure Passenger uses the bundled Ruby version
      passenger_ruby /opt/gitlab/embedded/bin/ruby;

      # Correct the $PATH variable to included packaged executables
      passenger_env_var PATH "/opt/gitlab/bin:/opt/gitlab/embedded/bin:/usr/local/bin:/usr/bin:/bin";

      # Make sure Passenger runs as the correct user and group to
      # prevent permission issues
      passenger_user git;
      passenger_group git;

      # Enable Passenger & keep at least one instance running at all times
      passenger_enabled on;
      passenger_min_instances 1;

      location ~ ^/[\w\.-]+/[\w\.-]+/(info/refs|git-upload-pack|git-receive-pack)$ {
         # 'Error' 418 is a hack to re-use the @gitlab-workhorse block
         error_page 418 = @gitlab-workhorse;
         return 418;
      }

      location ~ ^/[\w\.-]+/[\w\.-]+/repository/archive {
         # 'Error' 418 is a hack to re-use the @gitlab-workhorse block
         error_page 418 = @gitlab-workhorse;
         return 418;
      }

      location ~ ^/api/v3/projects/.*/repository/archive {
         # 'Error' 418 is a hack to re-use the @gitlab-workhorse block
         error_page 418 = @gitlab-workhorse;
         return 418;
      }

      # Build artifacts should be submitted to this location
      location ~ ^/[\w\.-]+/[\w\.-]+/builds/download {
            client_max_body_size 0;
            # 'Error' 418 is a hack to re-use the @gitlab-workhorse block
            error_page 418 = @gitlab-workhorse;
            return 418;
      }

      # Build artifacts should be submitted to this location
      location ~ /ci/api/v1/builds/[0-9]+/artifacts {
            client_max_body_size 0;
            # 'Error' 418 is a hack to re-use the @gitlab-workhorse block
            error_page 418 = @gitlab-workhorse;
            return 418;
      }

      # Build artifacts should be submitted to this location
      location ~ /api/v4/jobs/[0-9]+/artifacts {
            client_max_body_size 0;
            # 'Error' 418 is a hack to re-use the @gitlab-workhorse block
            error_page 418 = @gitlab-workhorse;
            return 418;
      }


      # For protocol upgrades from HTTP/1.0 to HTTP/1.1 we need to provide Host header if its missing
      if ($http_host = "") {
         # use one of values defined in server_name
         # 填入自己的域名
         set $http_host_with_default "git.example.com";
      }

      if ($http_host != "") {
         set $http_host_with_default $http_host;
      }

      location @gitlab-workhorse {

         ## https://github.com/gitlabhq/gitlabhq/issues/694
         ## Some requests take more than 30 seconds.
         proxy_read_timeout      3600;
         proxy_connect_timeout   300;
         proxy_redirect          off;

         # Do not buffer Git HTTP responses
         proxy_buffering off;

         proxy_set_header    Host                $http_host_with_default;
         proxy_set_header    X-Real-IP           $remote_addr;
         proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
         proxy_set_header    X-Forwarded-Proto   $scheme;

         proxy_pass http://gitlab-workhorse;

         ## The following settings only work with NGINX 1.7.11 or newer
         #
         ## Pass chunked request bodies to gitlab-workhorse as-is
         # proxy_request_buffering off;
         # proxy_http_version 1.1;
      }

      ## Enable gzip compression as per rails guide:
      ## http://guides.rubyonrails.org/asset_pipeline.html#gzip-compression
      ## WARNING: If you are using relative urls remove the block below
      ## See config/application.rb under "Relative url support" for the list of
      ## other files that need to be changed for relative url support
      location ~ ^/(assets)/ {
         root /opt/gitlab/embedded/service/gitlab-rails/public;
         gzip_static on; # to serve pre-gzipped version
         expires max;
         add_header Cache-Control public;
      }

      ## To access Grafana
      location /-/grafana/ {
         proxy_pass http://localhost:3000/;
      }

      error_page 502 /502.html;
   }
   ```

### 存储库位置迁移

#### 参考博客

- <https://blog.csdn.net/qq_36949713/article/details/89025198>
- <https://www.cnblogs.com/sanduzxcvbnm/p/14918291.html>

#### 迁移方式

gitlab的存储库默认路径为：`/var/opt/gitlab/git-data/`，这个目录下的`repositories`子文件夹里存放每个仓库内容，此文件夹在非root用户情况下是没有打开的权限的

如果需要默认的修改存储库，则需要：

1. 设置存储库位置
   采用Omnibus-gitlab安装包需要在`/etc/gitlab/gitlab.rb`中增添：

   ```ruby
   git_data_dirs({
     # 默认存储目录
   	"default" => {
   		"path" => "/var/opt/gitlab/git-data"
   	},
   	# 备用存储目录
     "alternative" => {
   		"path" => "/home/gitlab-data"
   	}     
   })
   
   ```

2. 迁移存储库已存的数据（没有数据可跳过）
   新仓库以`/home/$USER/gitlab-data/`为示例

   ```sh
   gitlab-ctl stop
   # 设置新的路径
   # rsync -av --delete <origin_path> <new_path>
   rsync -av --delete /var/opt/gitlab/git-data/repositories /home/$USER/gitlab-data/
   ```

3. 重启gitlab，更新配置

   ```sh
   gitlab-ctl stop
   gitlab-ctl reconfigure
   gitlab-ctl start
   ```

### Service Ping设置

参考链接：<https://docs.gitlab.com/ee/development/service_ping/index.html#disable-service-ping>

#### 禁用

13.12.3以后版本的禁用可以采用更新配置文件的方式禁用：

1. Omnibus软件安装包：需要在`/etc/gitlab/gitlab.rb`中添加：

   ```ruby
   gitlab_rails['usage_ping_enabled'] = false
   ```

   并在服务器中输入命令重新配置：

   ```sh
   sudo gitlab-ctl reconfigure
   ```

2. 源码安装：需要编辑`/home/git/gitlab/config/gitlab.yml`：

   ```ruby
   production: &base
     # ...
     gitlab:
       # ...
       usage_ping_enabled: false
   ```

   并重启Gitlab：

   ```sh
   sudo service gitlab restart
   ```

9.3到13.12.3中需要使用UI禁用(13.12.3之后的版本也可以这么做)

1. 使用[管理员身份](https://docs.gitlab.com/ee/user/permissions.html)登录
2. 在顶部栏选择**Menu > Admin**.
3. 在左侧选择**Settings > Metrics and profiling**
4. 点击**Usage statistics**
5. 取消勾选**Enable Service Ping**功能
6. 点击下方**Save changes**保存更改

### [取消注册功能](https://docs.gitlab.com/ee/user/admin_area/settings/sign_up_restrictions.html)

#### 禁用新注册

使用网页UI方式禁用：

1. 在顶部栏选择**Menu > Admin**
2. 在左侧栏选择**Settings > General**
3. 点击**Sign-up restrictions**
4. 取消勾选**Sign-up enabled**
5. 点击下方**Save changes**保存更改


### 修改全局用户设置

#### 取消用户创建Group权限

1. 使用Omnibus软件包安装：在`/etc/gitlab/gitlab.rb`中添加以下内容：

   ```ruby
   gitlab_rails['gitlab_default_can_create_group'] = false
   ```

   并重新配置启动Gitlab

2. 源代码安装；在`config/gitlab.yml`中修改为：

   ```ruby
   default_can_create_group: true
   ```

   并重启Gitlab

#### 取消用户更改username权限

1. 使用Omnibus软件包安装：在`/etc/gitlab/gitlab.rb`中添加以下内容：

   ```ruby
   gitlab_rails['gitlab_username_changing_enabled'] = false
   ```

   并重新配置启动Gitlab

2. 从源代码安装：在`config/gitlab.yml`中修改为：

   ```ruby
   username_changing_enabled: false
   ```

   并重启Gitlab



### [OmniAuth](https://docs.gitlab.com/ee/integration/omniauth.html#omniauth)

#### 禁用OmniAuth

1. 通过Omnibus安装：在`/etc/gitlab/gitlab.rb`中添加：

   ```ruby
   gitlab_rails['omniauth_enabled'] = false
   ```

2. 源代码安装：在`/home/git/gitlab/config/gitlab.yml`添加

   ```ruby
   omniauth:
     enabled: false
   ```

   

### [重置用户密码](https://docs.gitlab.com/ee/security/reset_user_password.html#reset-your-root-password)

#### Rake方式

13.9以后的版本可以用gitlab-rake任务的方式重置密码

```sh
sudo gitlab-rake "gitlab:password:reset"
```

然后输入用户名，新密码以及确认密码即可完成重置

如果需要重置管理员密码或指定用户的密码，也可以直接将用户名传入：

```sh
# username 即为想设定的用户名，要重置管理员密码则为root
sudo gitlab-rake "gitlab:password:reset[username]"
```

#### Rails Console方式

1. 启动Rails Console

2. 找到用户

   1. 通过username：

      ```ruby
      user = User.find_by_username 'exampleuser'
      ```

   2. 通过user ID：

      ```ruby
      # 示例ID为123，默认root用户id为1
      user = User.find(123)
      ```

   3. 通过email：

      ```ruby
      user = User.find_by(email: 'user@example.com')
      ```

3. 重置密码

   ```ruby
   # secret_pass为新的密码，请确保两次密码一致 
   user.password = 'secret_pass'
   user.password_confirmation = 'secret_pass'
   ```

4. 如果需要的话，可以使用电子邮件通知用户密码已修改成功

   ```ruby
   user.send_only_admin_changed_your_password_notification!
   ```

5. 保存用户

   ```ruby
   user.save!
   ```



### [Rails Console启动及使用](https://docs.gitlab.com/ee/administration/operations/rails_console.html)

#### 启动

1. Omnibus安装包方式

   ```sh
   sudo gitlab-rails console
   ```

2. 源代码安装

   ```sh
   sudo -u git -H bundle exec rails console -e production
   ```

#### 退出

在控制台中输入`:quit`

#### 输出Rails控制台会话历史记录

在控制台中输入：

```
puts Readline::HISTORY.to_a
```



### 更新相关

#### 替换新签名

如果出现签名过期的情况：

```shell
# The following signatures couldn’t be verified because the public key is not available: NO_PUBKEY 3F01618A51312F3F
# https://packages.gitlab.com/gitlab/gitlab-ee/el/7/x86_64/repodata/repomd.xml: [Errno -1] repomd.xml signature could not be verified for gitlab-ee
# W: 校验数字签名时出错。此仓库未被更新，所以仍然使用此前的索引文件。GPG 错误 https://mirrors.tuna.tsinghua.edu.cn/gitlab-ee/ubuntu focal InRelease:下列签名无校： EXPKEYSIG 3F01618A51312F3F GitLab B.V. (package repository signing key) <packages@gitlab.com>
# W: 无法下载 https://mirrors.tuna.tsinghua.edu.cn/gitlab-ee/ubuntu/dists/focal/InRelease  下列签名无效： EXPKEYSIG 3F01618A51312F3F GitLab B.V. (package reposiry signing key) <packages@gitlab.com>
```

需要替换签名：

```shell
curl https://packages.gitlab.com/gpg.key 2> /dev/null | sudo apt-key add - &>/dev/null
```





